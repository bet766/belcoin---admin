<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>ChatApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
}
.screen{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:#0072ff;
  color:#fff;
  border:none;
  font-weight:bold;
}
.hidden{display:none}
.msg{margin:5px 0}
.me{text-align:right;color:#0072ff}
.typing{font-size:12px;color:#999}
</style>
</head>

<body>

<div id="login" class="screen">
  <h2>Login</h2>
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <button onclick="cadastrar()">Cadastrar</button>
  <button onclick="reset()">Esqueci a senha</button>
</div>

<div id="app" class="screen hidden">
  <h3>Seu c칩digo</h3>
  <b id="meuCodigo"></b>

  <h3>Adicionar contato</h3>
  <input id="codigoContato" placeholder="C칩digo">
  <input id="nomeContato" placeholder="Nome">
  <button onclick="addContato()">Salvar</button>

  <h3>Contatos</h3>
  <div id="contatos"></div>

  <h3>Chat</h3>
  <div id="msgs"></div>
  <input id="msg" placeholder="Mensagem">
  <button onclick="enviar()">Enviar</button>

  <p id="digitando" class="typing"></p>
  <button onclick="logout()">Sair</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210",
  appId: "1:158588715768:web:15d8dd4f109250954cb10d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let chatAtual = null;

function gerarCodigo(){
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

function login(){
  auth.signInWithEmailAndPassword(email.value, senha.value)
    .catch(e=>alert(e.message));
}

function cadastrar(){
  auth.createUserWithEmailAndPassword(email.value, senha.value)
    .then(res=>{
      db.collection("users").doc(res.user.uid).set({
        code: gerarCodigo()
      });
    })
    .catch(e=>alert(e.message));
}

function reset(){
  auth.sendPasswordResetEmail(email.value)
    .then(()=>alert("Email enviado"));
}

auth.onAuthStateChanged(async user=>{
  if(!user) return;

  login.classList.add("hidden");
  app.classList.remove("hidden");

  const doc = await db.collection("users").doc(user.uid).get();
  meuCodigo.innerText = doc.data().code;

  carregarContatos();
});

function addContato(){
  db.collection("users")
    .where("code","==",codigoContato.value)
    .get()
    .then(s=>{
      if(s.empty) return alert("C칩digo inv치lido");
      const outro = s.docs[0].id;
      db.collection("contacts").doc(auth.currentUser.uid)
        .collection("list").doc(outro)
        .set({nome:nomeContato.value});
    });
}

function carregarContatos(){
  db.collection("contacts").doc(auth.currentUser.uid)
    .collection("list")
    .onSnapshot(s=>{
      contatos.innerHTML="";
      s.forEach(d=>{
        contatos.innerHTML+=`<div onclick="abrirChat('${d.id}')">${d.data().nome}</div>`;
      });
    });
}

function abrirChat(outro){
  chatAtual = [auth.currentUser.uid, outro].sort().join("_");

  db.collection("chats").doc(chatAtual)
    .collection("msgs").orderBy("time")
    .onSnapshot(s=>{
      msgs.innerHTML="";
      s.forEach(m=>{
        msgs.innerHTML+=`
          <div class="msg ${m.data().from===auth.currentUser.uid?'me':''}">
            ${m.data().text}
          </div>`;
      });
    });
}

function enviar(){
  if(!chatAtual) return;
  db.collection("chats").doc(chatAtual)
    .collection("msgs").add({
      from: auth.currentUser.uid,
      text: msg.value,
      time: Date.now()
    });
  msg.value="";
}

function logout(){
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>
