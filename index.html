<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat por C贸digo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f9b8e,#0a3d62);
}
.box{
  max-width:400px;
  margin:30px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
}
h2{text-align:center}
input,button{
  width:100%;
  padding:12px;
  margin:6px 0;
}
button{
  background:#0f9b8e;
  color:#fff;
  border:none;
  font-size:16px;
}
.link{
  text-align:center;
  color:#0f9b8e;
  cursor:pointer;
}
.hidden{display:none}

#chatBox{
  height:260px;
  overflow-y:auto;
  background:#f1f1f1;
  padding:10px;
  margin:10px 0;
}
.msg{
  padding:8px;
  margin:6px 0;
  border-radius:6px;
  max-width:80%;
}
.me{background:#c8f7c5;margin-left:auto}
.other{background:#ddd}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Login</h2>
<input id="loginEmail" placeholder="Email">
<input id="loginPass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<div class="link" onclick="showRegister()">Criar conta</div>
</div>

<!-- CADASTRO -->
<div class="box hidden" id="registerBox">
<h2>Cadastro</h2>
<input id="regName" placeholder="Nome">
<input id="regEmail" placeholder="Email">
<input id="regPass" type="password" placeholder="Senha">
<button onclick="register()">Cadastrar</button>
<div class="link" onclick="showLogin()">J谩 tenho conta</div>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
<h2>Perfil</h2>
<p id="myCode"></p>

<input id="contactCode" placeholder="C贸digo do contato">
<button onclick="openChat()">Abrir conversa</button>

<div id="chatBox"></div>

<input id="msgInput" placeholder="Mensagem">
<button onclick="sendMsg()">Enviar</button>

<div class="link" onclick="logout()">Sair</div>
</div>

<script>
//  FIREBASE
firebase.initializeApp({
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  projectId: "SEU_PROJECT_ID"
});

const auth = firebase.auth();
const db = firebase.firestore();

let chatId = null;
let unsubscribe = null;

// TELAS
function showRegister(){
  loginBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
}
function showLogin(){
  registerBox.classList.add("hidden");
  loginBox.classList.remove("hidden");
}

// GERAR CDIGO
function gerarCodigo(){
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

// CADASTRO
function register(){
  auth.createUserWithEmailAndPassword(regEmail.value, regPass.value)
  .then(res=>{
    return db.collection("users").doc(res.user.uid).set({
      name: regName.value,
      code: gerarCodigo()
    });
  })
  .catch(e=>alert(e.message));
}

// LOGIN
function login(){
  auth.signInWithEmailAndPassword(loginEmail.value, loginPass.value)
  .catch(e=>alert(e.message));
}

// LOGIN STATE
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    registerBox.classList.add("hidden");
    appBox.classList.remove("hidden");

    db.collection("users").doc(user.uid).get()
    .then(d=>{
      myCode.innerHTML = "Seu c贸digo: <b>"+d.data().code+"</b>";
    });
  }
});

// ABRIR CHAT
async function openChat(){
  if(unsubscribe) unsubscribe();
  chatBox.innerHTML = "";

  const snap = await db.collection("users")
  .where("code","==",contactCode.value).get();

  if(snap.empty) return alert("C贸digo n茫o encontrado");

  const otherId = snap.docs[0].id;
  chatId = [auth.currentUser.uid, otherId].sort().join("_");

  unsubscribe = db.collection("chats").doc(chatId)
  .collection("msgs").orderBy("time")
  .onSnapshot(s=>{
    chatBox.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.uid===auth.currentUser.uid?"me":"other");
      div.innerText=m.text;
      chatBox.appendChild(div);
    });
  });
}

// ENVIAR MSG
function sendMsg(){
  if(!chatId || !msgInput.value) return;
  db.collection("chats").doc(chatId)
  .collection("msgs").add({
    uid: auth.currentUser.uid,
    text: msgInput.value,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value="";
}

// SAIR
function logout(){
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>
