<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat por C처digo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
}
.screen{
  width:100%;
  max-width:390px;
  background:#fff;
  padding:22px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h2{text-align:center;color:#0072ff}
input,button{
  width:100%;
  padding:13px;
  margin:6px 0;
  border-radius:10px;
}
input{border:1px solid #ccc}
button{
  border:none;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
  color:#fff;
  font-size:16px;
  font-weight:bold;
}
.link{text-align:center;color:#0072ff;font-weight:bold;cursor:pointer}
.hidden{display:none}

/* APP */
.profile{text-align:center}
.profile img{
  width:80px;height:80px;border-radius:50%;object-fit:cover;
}
#chatBox{
  height:220px;background:#f2f2f2;
  padding:10px;border-radius:10px;overflow-y:auto;
}
.msg{padding:8px;border-radius:10px;margin:6px 0;max-width:80%}
.me{background:#00c6ff;color:#fff;margin-left:auto}
.other{background:#ddd}
.contact{
  padding:10px;border-bottom:1px solid #eee;cursor:pointer;
}
.contact:hover{background:#f0f0f0}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="screen" id="login">
<h2>Login</h2>
<input id="lEmail" placeholder="Email">
<input id="lPass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<div class="link" onclick="show('reset')">Esqueci a senha</div>
<div class="link" onclick="show('register')">Criar conta</div>
</div>

<!-- CADASTRO -->
<div class="screen hidden" id="register">
<h2>Cadastro</h2>
<input id="rEmail" placeholder="Email">
<input id="rPass" type="password" placeholder="Senha">
<input id="rPhoto" placeholder="URL da foto de perfil">
<button onclick="register()">Cadastrar</button>
<div class="link" onclick="show('login')">Voltar</div>
</div>

<!-- RESET -->
<div class="screen hidden" id="reset">
<h2>Recuperar senha</h2>
<input id="resetEmail" placeholder="Email">
<button onclick="resetPass()">Enviar</button>
<div class="link" onclick="show('login')">Voltar</div>
</div>

<!-- APP -->
<div class="screen hidden" id="app">
<div class="profile">
<img id="photo">
<p>Seu c처digo: <b id="myCode"></b></p>
</div>

<h3>Contatos</h3>
<div id="contacts"></div>

<input id="newCode" placeholder="C처digo do contato">
<input id="newName" placeholder="Nome para salvar">
<button onclick="addContact()">Adicionar</button>

<hr>

<div id="chatBox"></div>
<input id="msg">
<button onclick="send()">Enviar</button>

<div class="link" onclick="logout()">Sair</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCb3qXhVccF5zaM1kT7Y0qSgpyJlltTWSE",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210"
});

const auth=firebase.auth();
const db=firebase.firestore();
let chatId=null, unsubscribe=null;

function show(id){
  ["login","register","reset","app"].forEach(s=>document.getElementById(s).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function code(){return Math.random().toString(36).substr(2,6).toUpperCase();}

function register(){
  auth.createUserWithEmailAndPassword(rEmail.value,rPass.value)
  .then(res=>{
    return db.collection("users").doc(res.user.uid).set({
      code:code(),
      photo:rPhoto.value||"https://i.imgur.com/1X4jJYF.png"
    });
  });
}

function login(){
  auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
}

function resetPass(){
  auth.sendPasswordResetEmail(resetEmail.value)
  .then(()=>alert("Email enviado"));
}

auth.onAuthStateChanged(user=>{
  if(!user) return;
  show("app");
  db.collection("users").doc(user.uid).get().then(d=>{
    myCode.innerText=d.data().code;
    photo.src=d.data().photo;
  });
  loadContacts();
});

function addContact(){
  db.collection("contacts").doc(auth.currentUser.uid)
  .collection("items").add({
    code:newCode.value,
    name:newName.value
  });
  newCode.value="";newName.value="";
}

function loadContacts(){
  db.collection("contacts").doc(auth.currentUser.uid)
  .collection("items").onSnapshot(s=>{
    contacts.innerHTML="";
    s.forEach(d=>{
      const c=d.data();
      const div=document.createElement("div");
      div.className="contact";
      div.innerText=c.name+" ("+c.code+")";
      div.onclick=()=>openChat(c.code);
      contacts.appendChild(div);
    });
  });
}

async function openChat(code){
  if(unsubscribe)unsubscribe();
  const snap=await db.collection("users").where("code","==",code).get();
  if(snap.empty)return alert("N찾o encontrado");
  const other=snap.docs[0].id;
  chatId=[auth.currentUser.uid,other].sort().join("_");
  unsubscribe=db.collection("chats").doc(chatId)
  .collection("msgs").orderBy("time")
  .onSnapshot(s=>{
    chatBox.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.uid===auth.currentUser.uid?"me":"other");
      div.innerText=m.text;
      chatBox.appendChild(div);
    });
  });
}

function send(){
  if(!chatId||!msg.value)return;
  db.collection("chats").doc(chatId)
  .collection("msgs").add({
    uid:auth.currentUser.uid,
    text:msg.value,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  msg.value="";
}

function logout(){
  auth.signOut();location.reload();
}
</script>
</body>
</html>
