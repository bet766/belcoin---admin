<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>ChatApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
}
.app{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  padding:15px;
}
h2,h3{text-align:center}
input,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:#0072ff;
  color:#fff;
  font-weight:bold;
  border:none;
}
.small{font-size:12px;color:#555;text-align:center}
.contact{
  padding:12px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.chatBox{
  height:300px;
  overflow-y:auto;
  border:1px solid #ddd;
  padding:10px;
}
.msg{
  margin:5px 0;
}
.me{text-align:right;color:#0072ff}
.typing{font-size:12px;color:#999}
.blocked{color:red;font-size:12px}
.profile{
  text-align:center;
}
.profile img{
  width:80px;
  height:80px;
  border-radius:50%;
}
</style>
</head>

<body>
<div class="app" id="app"></div>

<script>
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210",
  storageBucket: "chat-a1210.appspot.com",
  messagingSenderId: "158588715768",
  appId: "1:158588715768:web:15d8dd4f109250954cb10d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const app = document.getElementById("app");

function code(){
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

/* LOGIN */
function renderLogin(){
app.innerHTML=`
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="register()">Cadastrar</button>
<button onclick="reset()">Esqueci a senha</button>
`;
}

function login(){
auth.signInWithEmailAndPassword(email.value,senha.value);
}

function register(){
auth.createUserWithEmailAndPassword(email.value,senha.value)
.then(res=>{
db.collection("users").doc(res.user.uid).set({
code:code(),
photo:"",
});
});
}

function reset(){
auth.sendPasswordResetEmail(email.value)
.then(()=>alert("Email enviado"));
}

/* APP */
auth.onAuthStateChanged(async user=>{
if(!user){renderLogin();return;}
const snap=await db.collection("users").doc(user.uid).get();
renderApp(user.uid,snap.data().code);
});

function renderApp(uid,myCode){
app.innerHTML=`
<h3>Seu código</h3>
<b>${myCode}</b>

<input id="cCode" placeholder="Código do contato">
<input id="cName" placeholder="Nome">
<button onclick="addContact('${uid}')">Adicionar</button>

<h3>Contatos</h3>
<div id="contacts"></div>

<div id="chat"></div>
`;
loadContacts(uid);
}

function addContact(uid){
db.collection("users").where("code","==",cCode.value).get()
.then(s=>{
if(s.empty){alert("Código inválido");return;}
const other=s.docs[0].id;
db.collection("contacts").doc(uid).collection("list").doc(other)
.set({name:cName.value,blocked:false});
});
}

function loadContacts(uid){
db.collection("contacts").doc(uid).collection("list")
.onSnapshot(s=>{
contacts.innerHTML="";
s.forEach(d=>{
contacts.innerHTML+=`
<div class="contact" onclick="openChat('${uid}','${d.id}','${d.data().name}',${d.data().blocked})">
${d.data().name}
${d.data().blocked?'<div class="blocked">Bloqueado</div>':''}
</div>`;
});
});
}

let typingTimeout;

function openChat(me,other,name,blocked){
if(blocked){alert("Contato bloqueado");return;}
const chatId=[me,other].sort().join("_");

chat.innerHTML=`
<h3>${name}</h3>
<div class="chatBox" id="msgs"></div>
<div class="typing" id="typing"></div>
<input id="msg">
<button onclick="send('${chatId}','${me}')">Enviar</button>
<button onclick="clearChat('${chatId}','${me}')">Apagar chat</button>
<button onclick="block('${me}','${other}')">Bloquear</button>
`;

db.collection("chats").doc(chatId).collection("msgs")
.orderBy("time")
.onSnapshot(s=>{
msgs.innerHTML="";
s.forEach(m=>{
msgs.innerHTML+=`
<div class="msg ${m.data().from===me?'me':''}">
${m.data().text}
${m.data().seen?' ✔✔':' ✔'}
</div>`;
});
});

msg.oninput=()=>{
db.collection("typing").doc(chatId).set({user:me});
clearTimeout(typingTimeout);
typingTimeout=setTimeout(()=>{
db.collection("typing").doc(chatId).delete();
},1000);
};

db.collection("typing").doc(chatId)
.onSnapshot(t=>{
typing.innerText=t.exists && t.data().user!==me?"Digitando...":"";
});
}

function send(chatId,me){
db.collection("chats").doc(chatId).collection("msgs").add({
text:msg.value,
from:me,
seen:false,
time:Date.now()
});
msg.value="";
}

function clearChat(chatId,me){
db.collection("chats").doc(chatId).collection("msgs")
.where("from","==",me).get()
.then(s=>s.forEach(d=>d.ref.delete()));
}

function block(me,other){
db.collection("contacts").doc(me).collection("list").doc(other)
.update({blocked:true});
alert("Contato bloqueado");
}
</script>
</body>
</html>
