<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>ChatApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase COMPAT (OBRIGATÓRIO) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
}
.app{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  padding:15px;
}
h2,h3{text-align:center}
input,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:#0072ff;
  color:#fff;
  font-weight:bold;
  border:none;
}
.contact{
  padding:12px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.chatBox{
  height:300px;
  overflow-y:auto;
  border:1px solid #ddd;
  padding:10px;
}
.msg{margin:5px 0}
.me{text-align:right;color:#0072ff}
.typing{font-size:12px;color:#999}
.blocked{color:red;font-size:12px}
</style>
</head>

<body>
<div class="app" id="app"></div>

<script>
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210",
  storageBucket: "chat-a1210.appspot.com",
  messagingSenderId: "158588715768",
  appId: "1:158588715768:web:15d8dd4f109250954cb10d"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const app = document.getElementById("app");

function gerarCodigo(){
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

function telaLogin(){
app.innerHTML=`
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="cadastro()">Cadastrar</button>
<button onclick="reset()">Esqueci a senha</button>
`;
}

function login(){
auth.signInWithEmailAndPassword(email.value,senha.value);
}

function cadastro(){
auth.createUserWithEmailAndPassword(email.value,senha.value)
.then(res=>{
db.collection("users").doc(res.user.uid).set({
code:gerarCodigo()
});
});
}

function reset(){
auth.sendPasswordResetEmail(email.value)
.then(()=>alert("Email de recuperação enviado"));
}

auth.onAuthStateChanged(async user=>{
if(!user){telaLogin();return;}
const doc=await db.collection("users").doc(user.uid).get();
telaApp(user.uid,doc.data().code);
});

function telaApp(uid,meuCodigo){
app.innerHTML=`
<h3>Seu código</h3>
<b>${meuCodigo}</b>

<input id="codigoContato" placeholder="Código do contato">
<input id="nomeContato" placeholder="Nome do contato">
<button onclick="addContato('${uid}')">Adicionar</button>

<h3>Contatos</h3>
<div id="lista"></div>
<div id="chat"></div>
`;
carregarContatos(uid);
}

function addContato(uid){
db.collection("users").where("code","==",codigoContato.value).get()
.then(s=>{
if(s.empty){alert("Código inválido");return;}
const outro=s.docs[0].id;
db.collection("contacts").doc(uid).collection("list").doc(outro)
.set({name:nomeContato.value,blocked:false});
});
}

function carregarContatos(uid){
db.collection("contacts").doc(uid).collection("list")
.onSnapshot(s=>{
lista.innerHTML="";
s.forEach(d=>{
lista.innerHTML+=`
<div class="contact" onclick="abrirChat('${uid}','${d.id}','${d.data().name}',${d.data().blocked})">
${d.data().name}
</div>`;
});
});
}

function abrirChat(me,other,nome,blocked){
if(blocked){alert("Contato bloqueado");return;}
const chatId=[me,other].sort().join("_");

chat.innerHTML=`
<h3>${nome}</h3>
<div class="chatBox" id="msgs"></div>
<input id="msg">
<button onclick="enviar('${chatId}','${me}')">Enviar</button>
`;

db.collection("chats").doc(chatId).collection("msgs")
.orderBy("time")
.onSnapshot(s=>{
msgs.innerHTML="";
s.forEach(m=>{
msgs.innerHTML+=`
<div class="msg ${m.data().from===me?'me':''}">
${m.data().text}
</div>`;
});
});
}

function enviar(chatId,me){
db.collection("chats").doc(chatId).collection("msgs").add({
text:msg.value,
from:me,
time:Date.now()
});
msg.value="";
}
</script>
</body>
</html>
