<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#0f9b8e,#0a3d62);
  color:#fff;
}

.container {
  max-width:400px;
  margin:40px auto;
  background:#fff;
  color:#000;
  padding:20px;
  border-radius:10px;
}

h2 { text-align:center }

input, button {
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  background:#0f9b8e;
  color:#fff;
  border:none;
  font-size:16px;
}

.link {
  text-align:center;
  margin-top:10px;
  color:#0f9b8e;
  cursor:pointer;
}

/* CHAT */
#chatBox {
  height:300px;
  overflow-y:auto;
  background:#f1f1f1;
  padding:10px;
  border-radius:6px;
}

.msg {
  margin:6px 0;
  padding:8px;
  border-radius:6px;
  max-width:80%;
}

.me { background:#c8f7c5; margin-left:auto }
.other { background:#ddd }

.hidden { display:none }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginScreen">
  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <div class="link" onclick="showRegister()">Criar conta</div>
</div>

<!-- CADASTRO -->
<div class="container hidden" id="registerScreen">
  <h2>Cadastro</h2>
  <input id="regName" placeholder="Nome">
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password" placeholder="Senha">
  <button onclick="register()">Cadastrar</button>
  <div class="link" onclick="showLogin()">J√° tenho conta</div>
</div>

<!-- CHAT -->
<div class="container hidden" id="chatScreen">
  <h2>Chat</h2>
  <p id="myCode"></p>

  <input id="contactCode" placeholder="C√≥digo do contato">
  <button onclick="openChat()">Abrir conversa</button>

  <div id="chatBox"></div>

  <input id="msgInput" placeholder="Mensagem">
  <button onclick="sendMsg()">Enviar</button>

  <div class="link" onclick="logout()">Sair</div>
</div>

<script>
// üî• FIREBASE CONFIG
firebase.initializeApp({
  apiKey: "AIzaSyCb3qXhVccF5zaM1kT7Y0qSgpyJlltTWSE",
  authDomain: "chat-a1210.firebaseapp.com",
  projectId: "chat-a1210"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentChat = null;

// üîÅ TELAS
function showRegister() {
  loginScreen.classList.add("hidden");
  registerScreen.classList.remove("hidden");
}

function showLogin() {
  registerScreen.classList.add("hidden");
  loginScreen.classList.remove("hidden");
}

// üîë C√ìDIGO √öNICO
function gerarCodigo() {
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

// üìù CADASTRO
function register() {
  const name = regName.value;
  const email = regEmail.value;
  const pass = regPass.value;

  if(!name || !email || !pass) {
    alert("Preencha todos os campos");
    return;
  }

  auth.createUserWithEmailAndPassword(email, pass)
    .then(res => {
      const code = gerarCodigo();
      db.collection("users").doc(res.user.uid).set({
        name, email, code
      });
    })
    .catch(e => alert(e.message));
}

// üîì LOGIN
function login() {
  auth.signInWithEmailAndPassword(loginEmail.value, loginPass.value)
    .catch(e => alert(e.message));
}

// üöÄ LISTENER DE LOGIN (AQUI ESTAVA O PROBLEMA)
auth.onAuthStateChanged(user => {
  if(user) {
    loginScreen.classList.add("hidden");
    registerScreen.classList.add("hidden");
    chatScreen.classList.remove("hidden");

    db.collection("users").doc(user.uid).get()
      .then(doc => {
        myCode.innerHTML = "Seu c√≥digo: <b>" + doc.data().code + "</b>";
      });
  }
});

// üí¨ ABRIR CHAT
async function openChat() {
  const code = contactCode.value.trim();
  const snap = await db.collection("users").where("code","==",code).get();
  if(snap.empty) return alert("Usu√°rio n√£o encontrado");

  const other = snap.docs[0].id;
  currentChat = [auth.currentUser.uid, other].sort().join("_");

  db.collection("chats").doc(currentChat)
    .collection("msgs")
    .orderBy("time")
    .onSnapshot(s => {
      chatBox.innerHTML = "";
      s.forEach(d => {
        const m = d.data();
        const div = document.createElement("div");
        div.className = "msg " + (m.uid === auth.currentUser.uid ? "me" : "other");
        div.innerText = m.text;
        chatBox.appendChild(div);
      });
    });
}

// ‚úâÔ∏è ENVIAR
function sendMsg() {
  if(!currentChat) return;
  db.collection("chats").doc(currentChat)
    .collection("msgs").add({
      uid: auth.currentUser.uid,
      text: msgInput.value,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
  msgInput.value = "";
}

// üö™ LOGOUT
function logout() {
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>
